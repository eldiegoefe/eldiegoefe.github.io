<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="El Diego Efe" />
        <meta name="copyright" content="El Diego Efe" />

        <meta name="description" content="La comunicación mediante USB con microcontroladores me viene resultando un escollo permanente. El protocolo en sí tiene una complejidad que requiere más tiempo de estudio para comprenderlo que el que estoy dispuesto a dedicarle, sobre todo porque empecé a leer varias veces sobre el mismo y siempre me encuentro dando …
" />
<meta name="keywords" content="mbed, usb, python, electronica, tecnicismos, " />
        <title>Comunicacion <span class="caps">USB</span> con&nbsp;mbed  · Certezas Dudosas
</title>
        <link href="https://cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="https://eldiegoefe.github.io/theme/css/style.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://eldiegoefe.github.io/theme/css/solarizedlight.css" media="screen">
        <link rel="shortcut icon" href="https://eldiegoefe.github.io/theme/images/favicon.ico" type="image/x-icon" />
        <link rel="apple-touch-icon" href="https://eldiegoefe.github.io/theme/images/apple-touch-icon.png" />
        <link rel="apple-touch-icon" sizes="57x57" href="https://eldiegoefe.github.io/theme/images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="https://eldiegoefe.github.io/theme/images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="https://eldiegoefe.github.io/theme/images/apple-touch-icon-114x114.png" />
        <link rel="apple-touch-icon" sizes="144x144" href="https://eldiegoefe.github.io/theme/images/apple-touch-icon-144x144.png" />
        <link rel="icon" href="https://eldiegoefe.github.io/theme/images/apple-touch-icon-144x144.png" />
        <link href="https://eldiegoefe.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Certezas Dudosas - Full RSS Feed" />
        <link href="https://eldiegoefe.github.io/feeds/blog.rss.xml" type="application/atom+xml" rel="alternate" title="Certezas Dudosas - blog Category RSS Feed" />
        <link href="https://eldiegoefe.github.io/feeds/politica.rss.xml" type="application/atom+xml" rel="alternate" title="Certezas Dudosas - politica Category RSS Feed" />
        <link href="https://eldiegoefe.github.io/feeds/salud.rss.xml" type="application/atom+xml" rel="alternate" title="Certezas Dudosas - salud Category RSS Feed" />
        <link href="https://eldiegoefe.github.io/feeds/tecnicismos.rss.xml" type="application/atom+xml" rel="alternate" title="Certezas Dudosas - tecnicismos Category RSS Feed" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="https://eldiegoefe.github.io/"><span class=site-name>Certezas Dudosas</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="https://eldiegoefe.github.io">Home</a></li>
                            <li ><a href="https://eldiegoefe.github.io/categories.html">Categories</a></li>
                            <li ><a href="https://eldiegoefe.github.io/tags.html">Tags</a></li>
                            <li ><a href="https://eldiegoefe.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="https://eldiegoefe.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page_header span10 offset2">
    <h1><a href="https://eldiegoefe.github.io/comunicacion-usb-con-mbed.html"> Comunicacion <span class="caps">USB</span> con&nbsp;mbed  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            <p>La comunicación mediante <span class="caps">USB</span> con microcontroladores me viene
resultando un escollo permanente. El protocolo en sí tiene una
complejidad que requiere más tiempo de estudio para comprenderlo que
el que estoy dispuesto a dedicarle, sobre todo porque empecé a leer
varias veces sobre el mismo y siempre me encuentro dando vueltas
alrededor de detalles que parecen demasiado específicos y alejados de
lo que yo necesito lograr. Decidí hacer la prueba con mbed, ya que
tengo una placa kinetis frdm-kl25z de freescale, con la cual hay unos
ejemplos de comunicación que parecen muy&nbsp;sencillos.</p>
<div class="section" id="microcontrolador">
<h2>Microcontrolador</h2>
<p>Del lado del mbed el programa es el&nbsp;siguiente:</p>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;USBHID.h&quot;</span><span class="cp"></span>

<span class="c1">//We declare a USBHID device. Input out output reports have a length of 8 bytes</span>
<span class="n">USBHID</span> <span class="nf">hid</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

<span class="c1">//This report will contain data to be sent</span>
<span class="n">HID_REPORT</span> <span class="n">send_report</span><span class="p">;</span>
<span class="n">HID_REPORT</span> <span class="n">recv_report</span><span class="p">;</span>

<span class="n">Serial</span> <span class="nf">pc</span><span class="p">(</span><span class="n">USBTX</span><span class="p">,</span> <span class="n">USBRX</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">send_report</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//Fill the report</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">send_report</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">send_report</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//Send the report</span>
        <span class="n">hid</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_report</span><span class="p">);</span>

        <span class="c1">//try to read a msg</span>
        <span class="k">if</span><span class="p">(</span><span class="n">hid</span><span class="p">.</span><span class="n">readNB</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recv_report</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">pc</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;recv: &quot;</span><span class="p">);</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">recv_report</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pc</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">recv_report</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="n">pc</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">wait</span><span class="p">(</span><span class="mf">0.1</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
<p>En el foro de mbed (<a class="reference external" href="https://mbed.org/questions/1348/Whats-the-difference-between-read-and-re/">aca</a>) preguntan cuál es la diferencia entre read y
readNB, y también entre send y&nbsp;sendNB:</p>
<p>If there is data to read, read and read_nb do the same, they return
that data. If not, readNB will return directly that there was no data
to read, while read blocks until there is&nbsp;data.</p>
<p>Send is pretty much the same, only then related to the output
buffer. If the output buffer is empty, both will simply put the data
in it and return. If it is full, non-blocking will tell there is no
space, while blocking will wait until there is&nbsp;space.</p>
</div>
<div class="section" id="computadora">
<h2>Computadora</h2>
<p>Del lado de la computadora, el programa en python&nbsp;es:</p>
<div class="highlight"><pre><span></span><span class="c1">#</span>
<span class="c1">#Simple example on how to send and receive data to the Mbed over USB (on Linux) using pyUSB 1.0</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">usb.core</span>    <span class="c1"># the main USB module</span>
<span class="kn">import</span> <span class="nn">usb.util</span>    <span class="c1"># utility functions</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># handler called when a report is received</span>
<span class="k">def</span> <span class="nf">rx_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;recv: &#39;</span><span class="p">,</span> <span class="n">data</span>

<span class="k">def</span> <span class="nf">tx_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">print</span> <span class="s1">&#39;env: &#39;</span><span class="p">,</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">findHIDDevice</span><span class="p">(</span><span class="n">mbed_vendor_id</span><span class="p">,</span> <span class="n">mbed_product_id</span><span class="p">):</span>
    <span class="c1"># Find device</span>
    <span class="n">hid_device</span> <span class="o">=</span> <span class="n">usb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">idVendor</span><span class="o">=</span><span class="n">mbed_vendor_id</span><span class="p">,</span><span class="n">idProduct</span><span class="o">=</span><span class="n">mbed_product_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">hid_device</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;No device connected&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mbed found</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hid_device</span><span class="o">.</span><span class="n">is_kernel_driver_active</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hid_device</span><span class="o">.</span><span class="n">detach_kernel_driver</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">usb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">USBError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not detatch kernel driver: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># set the active configuration. With no arguments, the first</span>
            <span class="c1"># configuration will be the active one</span>
            <span class="n">hid_device</span><span class="o">.</span><span class="n">set_configuration</span><span class="p">()</span>
            <span class="n">hid_device</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">usb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">USBError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not set configuration: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">hid_device</span><span class="p">[</span><span class="mi">0</span><span class="p">][(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span>

            <span class="c1">#read the data</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="n">hid_device</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">endpoint</span><span class="o">.</span><span class="n">bEndpointAddress</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">rx_handler</span><span class="p">(</span><span class="nb">bytes</span><span class="p">);</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

            <span class="n">tx_handler</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>

            <span class="n">hid_device</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>    <span class="c1"># 1 es el endpoint</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># The vendor ID and product ID used in the Mbed program</span>
    <span class="n">mbed_vendor_id</span> <span class="o">=</span> <span class="mh">0x1234</span>
    <span class="n">mbed_product_id</span> <span class="o">=</span> <span class="mh">0x0006</span>

    <span class="c1"># Search the Mbed, attach rx handler and send data</span>
    <span class="n">findHIDDevice</span><span class="p">(</span><span class="n">mbed_vendor_id</span><span class="p">,</span> <span class="n">mbed_product_id</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="en-funcionamiento">
<h2>En&nbsp;funcionamiento</h2>
<p>En la imagen puede verse la pantalla de emacs donde se ve el envío y recepción de&nbsp;datos.</p>
<div class="figure align-center">
<a class="reference external image-reference" href="https://farm9.staticflickr.com/8635/16105028699_94525b70ba_o.jpg"><img alt="Pantalla de emacs donde se ve el envío y recepción de datos." src="https://farm9.staticflickr.com/8635/16105028699_317b3557d9_b.jpg" style="width: 100.0%;" /></a>
</div>
</div>
<div class="section" id="problema-resuelto">
<h2>Problema&nbsp;resuelto</h2>
<p>Hay un problema al ejecutar el programa de la computadora (lo cual
hago usando ipython, tanto en modo terminal como en modo notebook) que
dispara el siguiente&nbsp;error:</p>
<div class="highlight"><pre><span></span><span class="go">USBError: [Errno 13] Access denied (insufficient permissions)</span>
</pre></div>
<p>Esto tiene que ver con los permisos para usar el <span class="caps">USB</span>. Una solución rápida es ejecutar el script de python con permisos de root, para lo cual alcanza con correr ipython anteponiendo&nbsp;sudo:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo ipython
</pre></div>
<p>Recuerdo haber seguido unas instrucciones para habilitar el usuario a trabajar con el <span class="caps">USB</span>, pero no recuerdo dónde estaban y ahora no puedo encontrarlas (aunque salen muchas páginas si uno busca este&nbsp;error).</p>
</div>

<section>
<p id="comment-message">No te vayas sin comentar algo del post, de las noticias del día, del clima, que se yo... </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                    data-disqus-identifier="comunicacion usb con mbed"
                href="https://eldiegoefe.github.io/comunicacion-usb-con-mbed.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'certezasdudosas';
        var disqus_identifier = 'comunicacion usb con mbed';
    var disqus_url = 'https://eldiegoefe.github.io/comunicacion-usb-con-mbed.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>                </div>
            </div>
        </div>
    </div>
</div>
</section>
            <aside>
            <hr/>
            <nav>
            <ul class="articles_timeline">
 
                <li class="previous_article">« <a href="https://eldiegoefe.github.io/sincronizando-con-git.html" title="Previous: Sincronizando con&nbsp;Git">Sincronizando con&nbsp;Git</a></li>
 
                <li class="next_article"><a href="https://eldiegoefe.github.io/cheat-sheet-para-programacion.html" title="Next: Cheat sheet para&nbsp;programación">Cheat sheet para&nbsp;programación</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
 
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-07-31T10:00:00-03:00">jul 31, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="/categories.html#tecnicismos-ref">tecnicismos</a> 
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article"> 
                <li><a href="/tags.html#electronica-ref">electronica
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#mbed-ref">mbed
                    <span>2</span>
</a></li>
                <li><a href="/tags.html#python-ref">python
                    <span>7</span>
</a></li>
                <li><a href="/tags.html#usb-ref">usb
                    <span>1</span>
</a></li>
            </ul>

        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-subtitle"><span class="site-name">Certezas Dudosas</span> - todo lo liquido se desvanece en el estomago</li>
        <li class="elegant-license">Podes usar el contenido de este blog si pones un link hacia https://eldiegoefe.github.io/</li>
        <li class="elegant-power">Powered by <a href="https://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="https://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="https://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="https://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

<script type="text/javascript">
    var disqus_shortname = 'certezasdudosas';

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
        <script  language="javascript" type="text/javascript">
            function uncollapse() {
                var hash_str = window.location.hash;
                if (window.location.hash.match(/^#comment-\d+$/))
                {
                    var hash_str = '#disqus_thread';
                }
                $(hash_str).collapse({
                    toggle: true
                    })
            }
        </script>

        <script type="text/javascript" language="JavaScript">
            uncollapse(); 
        </script>
    </body>
</html>